webshim.register("filereader-xhr",function(e,t,o,a,n,r){"use strict";var i,s,l,u='input[type="file"].ws-filereader, input[type="file"].ws-capture',d=swfmini.hasFlashPlayerVersion("10.3"),p=function(){t.loader.loadList(["moxie"])},f=function(){var o,a,n,r,s=this;t.implement(s,"filepicker")&&(s=this,o=e(this),n=o.parent(),r=function(){s.value||o.prop("value","")},o.attr("tabindex","-1").on("mousedown.filereaderwaiting click.filereaderwaiting",!1),n.addClass("ws-loading"),a=new i.FileInput({browse_button:this,accept:e.prop(this,"accept"),multiple:e.prop(this,"multiple")}),o.jProp("form").on("reset",function(){setTimeout(r)}),a.onready=function(){o.off(".fileraderwaiting"),n.removeClass("ws-waiting")},a.onchange=function(e){t.data(s,"fileList",e.target.files),o.trigger("change")},a.onmouseenter=function(){o.trigger("mouseover"),n.addClass("ws-mouseenter")},a.onmouseleave=function(){o.trigger("mouseout"),n.removeClass("ws-mouseenter")},a.onmousedown=function(){o.trigger("mousedown"),n.addClass("ws-active")},a.onmouseup=function(){o.trigger("mouseup"),n.removeClass("ws-active")},t.data(s,"filePicker",a),t.ready("WINDOWLOAD",function(){var e;o.onWSOff("updateshadowdom",function(){var t=s.offsetWidth;t&&e!=t&&(e=t,a.refresh())})}),t.addShadowDom(),a.init(),s.disabled&&a.disable(!0))},c=function(e){return e.name},m=function(){var o=this;p(),e(o).on("mousedown.filereaderwaiting click.filereaderwaiting",!1).parent().addClass("ws-loading"),t.ready("moxie",function(){m.call(o)})},h=/^(?:script|jsonp)$/i,y=function(){p(),t.error('filereader/formdata not ready yet. please wait for moxie to load `webshim.ready("moxie", callbackFn);`` or wait for the first change event on input[type="file"].ws-filereader.')},g=t.defineNodeNameProperty("input","value",{prop:{get:function(){var e=t.data(this,"fileList");return e&&e.map?e.map(c).join(", "):g.prop._supget.call(this)}}}),w=t.cfg.basePath+"moxie/",x='You nedd a crossdomain.xml to get all "filereader" / "XHR2" / "CORS" features to work. Or host moxie.swf on your server an configure filereader options: "swfpath"',v=function(t){return"moxie"==t.wsType||t.data&&t.data instanceof i.FormData||t.crossDomain&&e.support.cors!==!1&&"no"!=l&&!h.test(t.dataType||"")},b=function(o){if(v(o)){var a;return t.info("moxie transfer used for $.ajax"),"no"==l&&t.error(x),{send:function(t,n){var i=function(e,t){if(o[t]){var n=!1;a.addEventListener("load",function(){n?n.lengthComputable&&n.total>n.loaded&&o[t]({type:"progress",lengthComputable:!0,total:n.total,loaded:n.total}):o[t]({type:"progress",lengthComputable:!0,total:1,loaded:1})}),e.addEventListener("progress",function(e){n=e,o[t](e)})}};a=new s.xhr.XMLHttpRequest,a.open(o.type,o.url,o.async,o.username,o.password),i(a.upload,r.uploadprogress),i(a.upload,r.progress),a.addEventListener("load",function(){var e={text:a.responseText,xml:a.responseXML};n(a.status,a.statusText,e,a.getAllResponseHeaders())}),o.xhrFields&&o.xhrFields.withCredentials&&(a.withCredentials=!0),o.timeout&&(a.timeout=o.timeout),e.each(t,function(e,t){a.setRequestHeader(e,t)}),a.send(o.data)},abort:function(){a&&a.abort()}}}},L={xdomain:function(){var o=/^https?:\/\//i,a=/^get|post$/i,n=new RegExp("^"+location.protocol,"i");return function(r,s){if(!(!r.crossDomain||r.username||r.xhrFields&&r.xhrFields.withCredentials||!r.async||!a.test(r.type)||!o.test(r.url)||!n.test(r.url)||r.data&&r.data instanceof i.FormData||h.test(r.dataType||""))){var l=null;return t.info("xdomain transport used."),{send:function(t,o){var a="",n=(s.dataType||"").toLowerCase();l=new XDomainRequest,/^\d+$/.test(s.timeout)&&(l.timeout=s.timeout),l.ontimeout=function(){o(500,"timeout")},l.onload=function(){var t="Content-Length: "+l.responseText.length+"\r\nContent-Type: "+l.contentType,a={code:l.status||200,message:l.statusText||"OK"},r={text:l.responseText,xml:l.responseXML};try{if("html"===n||/text\/html/i.test(l.contentType))r.html=l.responseText;else if("json"===n||"text"!==n&&/\/json/i.test(l.contentType))try{r.json=e.parseJSON(l.responseText)}catch(i){}else if("xml"===n&&!l.responseXML){var s;try{s=new ActiveXObject("Microsoft.XMLDOM"),s.async=!1,s.loadXML(l.responseText)}catch(i){}r.xml=s}}catch(u){}o(a.code,a.message,r,t)},l.onprogress=function(){},l.onerror=function(){o(500,"error",{text:l.responseText})},s.data&&(a="string"===e.type(s.data)?s.data:e.param(s.data)),l.open(r.type,r.url),l.send(a)},abort:function(){l&&l.abort()}}}}}(),moxie:function(e,o,a){if(v(e)){p(e);var n,r={send:function(i,s){n=!0,t.ready("moxie",function(){n&&(n=b(e,o,a),r.send=n.send,r.abort=n.abort,n.send(i,s))})},abort:function(){n=!1}};return r}}};t.loader.addModule("moxie",{src:"moxie/js/moxie-"+(d?"swf":"html4")}),r.progress||(r.progress="onprogress"),r.uploadprogress||(r.uploadprogress="onuploadprogress"),r.swfpath||(r.swfpath=w+"flash/Moxie.min.swf"),e.support.cors===!1&&o.XDomainRequest||delete L.xdomain,e.ajaxTransport("+*",function(e,t,o){var a,n;if((e.wsType||L[L])&&(a=L[L](e,t,o)),!a)for(n in L)if(a=L[n](e,t,o))break;return a}),t.defineNodeNameProperty("input","files",{prop:{writeable:!1,get:function(){return"file"!=this.type?null:(e(this).is(".ws-filereader, .ws-capture")||t.info("please add the 'ws-filereader'/'ws-capture' class to your input[type='file'] to implement files-property"),t.data(this,"fileList")||[])}}}),t.reflectProperties(["input"],["accept"]),null==e("<input />").prop("multiple")&&t.defineNodeNamesBooleanProperty(["input"],["multiple"]),t.onNodeNamesPropertyModify("input","disabled",function(e,o){var a=t.data(this,"filePicker");a&&a.disable(o)}),t.onNodeNamesPropertyModify("input","value",function(o){""===o&&"file"==this.type&&e(this).is(".ws-filereader, .ws-capture")&&t.data(this,"fileList",[])}),a.createElement("canvas").toBlob||(t.defineNodeNameProperty("canvas","toBlob",{prop:{value:function(o,a,n){var r,s=e(this);a||(a="image/jpeg"),"image/jpeg"!=a||n||(n=.8),p(),setTimeout(function(){r=s.callProp("getAsDataURL",[a,n]),t.ready("moxie",function(){var e=new i.Image;e.onload=function(){var a=e.getAsBlob();t.defineProperty(a,"_wsDataURL",{value:r,enumerable:!1}),o(a)},e.load(r)})},9)}}}),t.ready("url",function(){var e=URL.createObjectURL,t=URL.revokeObjectURL;URL.createObjectURL=function(t){var o=t;if(t._wsimgDataURL)o=t._wsimgDataURL;else if(e)return e.apply(this,arguments);return o},URL.revokeObjectURL=function(){return t?t.apply(this,arguments):void 0}})),o.FileReader=y,o.FormData=y,t.ready("moxie",function(){var a="application/xml,xml";s=o.moxie,i=o.mOxie,i.Env.swf_url=r.swfpath,o.FileReader=i.FileReader,o.FormData=function(o){var a,n,r,s,l,u,d,p=new i.FormData;if(o&&e.nodeName(o,"form")){for(a=e(o).serializeArray(),n=0;n<a.length;n++)Array.isArray(a[n].value)?a[n].value.forEach(function(e){p.append(a[n].name,e)}):p.append(a[n].name,a[n].value);for(a=o.querySelectorAll('input[type="file"][name]'),n=0,r=a.length;n<a.length;n++)if(d=a[n].name,d&&!e(a[n]).is(":disabled")&&(s=e.prop(a[n],"files")||[],s.length))for((s.length>1||p.hasBlob&&p.hasBlob())&&t.error("FormData shim can only handle one file per ajax. Use multiple ajax request. One per file."),l=0,u=s.length;u>l;l++)p.append(d,s[l])}return p},m=f,L.moxie=b,r.mimeTypes=r.mimeTypes?a+","+r.mimeTypes:a;try{i.Mime.addMimeType(r.mimeTypes)}catch(n){t.warn("mimetype to moxie error: "+n)}}),t.addReady(function(t,o){e(t.querySelectorAll(u)).add(o.filter(u)).each(m)}),t.ready("WINDOWLOAD",p),t.cfg.debug!==!1&&r.swfpath.indexOf(location.protocol+"//"+location.hostname)&&r.swfpath.indexOf("https://"+location.hostname)&&t.ready("WINDOWLOAD",function(){var o=function(){"no"==l&&t.error(x)};try{l=sessionStorage.getItem("wsXdomain.xml")}catch(a){}if(o(),null==l)try{e.ajax({url:"crossdomain.xml",type:"HEAD",dataType:"xml",success:function(){l="yes"},error:function(){l="no"},complete:function(){try{sessionStorage.setItem("wsXdomain.xml",l)}catch(e){}o()}})}catch(a){}}),"complete"==a.readyState&&webshims.isReady("WINDOWLOAD",!0)});